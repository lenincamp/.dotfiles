function sfcov() {
    # Check dependencies
    if ! command -v fzf &> /dev/null || ! command -v jq &> /dev/null; then
        echo "âŒ Error: 'fzf' and 'jq' are required for this command."
        return 1
    fi

    echo "ðŸ”Ž Scanning local Apex classes for analysis..."

    # 1. Get list of all local Apex classes
    local class_names=$(find . -path '*/main/default/classes/*.cls' -print 2>/dev/null | xargs -n 1 basename | sed 's/\.cls$//')

    if [[ -z "$class_names" ]]; then
        echo "âŒ No Apex classes found in the project's default folders."
        return 1
    fi

    # 2. Interactive selection with FZF (select the class to analyze)
    local selected_class=$(echo "$class_names" | sort | fzf \
        --prompt="ðŸ“ Select Apex Class to Analyze Coverage: " \
        --height=20 --layout=reverse --border)

    if [[ -z "$selected_class" ]]; then
        echo "âŒ Coverage analysis cancelled."
        return
    fi
    
    # 3. Execute all tests to get comprehensive, fresh coverage data
    echo "---------------------------------------------------"
    echo "ðŸ”¥ Running all local tests to generate fresh coverage data..."
    
    # We run all tests to ensure the selected class gets covered by all relevant test classes.
    local test_command="sf apex run test --code-coverage --json"
    local result_json=$(eval $test_command)
    local exit_code=$?

    if [[ $exit_code -ne 0 ]]; then
        echo "âŒ Test run failed. Coverage data is not reliable. Showing raw output."
        echo "$result_json"
        return $exit_code
    fi

    # 4. Use JQ to parse the result and extract coverage for the selected class
    local coverage_data=$(echo "$result_json" | jq -r ".result.coverage.coverage[] | select(.name==\"$selected_class\")")

    if [[ -z "$coverage_data" ]]; then
        echo "âš ï¸ Could not find coverage data for \033[1;33m$selected_class\033[0m. Ensure it's deployed and referenced by a test."
        return 1
    fi

    local covered=$(echo "$coverage_data" | jq -r '.numLinesCovered')
    local uncovered=$(echo "$coverage_data" | jq -r '.numLinesUncovered')
    local total=$((covered + uncovered))

    # Calculate percentage with basic shell arithmetic (scale to 2 decimals)
    # Note: bc is required for floating-point math in shell
    if ! command -v bc &> /dev/null; then
        echo "âš ï¸ Warning: 'bc' is required for percentage calculation. Showing raw numbers only."
        local percentage="N/A"
    else
        local percentage=$(echo "scale=2; ($covered / $total) * 100" | bc 2>/dev/null)
    fi

    local uncovered_lines=$(echo "$coverage_data" | jq -r '.uncoveredLines | .[]')
    
    # 5. Display the results
    echo "---------------------------------------------------"
    echo "ðŸ“Š Coverage Report for \033[1;32m$selected_class\033[0m:"
    echo "---------------------------------------------------"
    echo "  Total Lines: $total"
    echo "  Covered:     $covered"
    echo "  Uncovered:   $uncovered"
    echo "  Coverage %:  \033[1;36m$percentage%\033[0m"
    echo ""

    if [[ -z "$uncovered_lines" ]]; then
        echo "ðŸ¥³ \033[1;32m100% Coverage! No uncovered lines found.\033[0m"
    else
        echo "ðŸ’” \033[1;31mUNCOVERED LINES:\033[0m"
        echo "----------------------"
        # Display uncovered lines as a comma-separated list
        echo "$uncovered_lines" | tr '\n' ',' | sed 's/,$//'
        echo ""
    fi
}
