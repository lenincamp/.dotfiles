function sftr() {
    # Requiere fzf
    if ! command -v fzf &> /dev/null; then
        echo "‚ùå Error: 'fzf' is required for interactive selection."
        return 1
    fi
    
    echo "üîé Scanning local Apex test classes..."

    # 1. Obtener la lista de clases Apex locales
    local class_names=$(find . -path '*/main/default/classes/*.cls' -print 2>/dev/null | xargs -n 1 basename | sed 's/\.cls$//')

    if [[ -z "$class_names" ]]; then
        echo "‚ùå No Apex classes found in the project's default folders."
        return 1
    fi

    # 2. Selecci√≥n Interactiva con FZF (permite selecci√≥n m√∫ltiple con TAB)
    local selected_classes=$(echo "$class_names" | sort | fzf --multi \
        --prompt="üìù Select Apex Test Class(es) or Method(s): " \
        --header="Use TAB to select multiple, type Name.Method for specific methods." \
        --height=50% --layout=reverse --border)

    if [[ -z "$selected_classes" ]]; then
        echo "‚ùå Test execution cancelled."
        return
    fi

    # 3. Formatear para el comando SF (Clase1,Clase2 o Clase1.Metodo1)
    # CORRECCI√ìN: Reemplazamos saltos de l√≠nea por comas y eliminamos la coma final.
    local run_parameter=$(echo "$selected_classes" | tr '\n' ',' | sed 's/,$//')
    
    # 4. Ejecuci√≥n de Prueba y Obtenci√≥n del Log
    echo "---------------------------------------------------"
    echo "üî• Executing tests for: \033[1;36m$run_parameter\033[0m"
    echo "---------------------------------------------------"

    # Comando de ejecuci√≥n
    local test_command="sf apex run test --class-names $run_parameter --json"

    # Ejecutar y capturar el JSON del resultado
    local result_json=$(eval $test_command)
    local exit_code=$?

    if [[ $exit_code -ne 0 ]]; then
        echo "‚ùå Test execution failed. Showing raw output."
        echo "$result_json"
        return $exit_code
    fi

    # Extracci√≥n de Log ID: Limpiamos caracteres de control para jq.
    local log_id=$(echo "$result_json" | tr -d '[:cntrl:]' | jq -r '.result.debugLogId')

    if [[ -n "$log_id" && "$log_id" != "null" ]]; then
        echo "‚úÖ Tests finished successfully. Opening log: \033[1;33m$log_id\033[0m"
        echo "---------------------------------------------------"
        
        # 5. Abrir el Log (Usamos 'tail' para verlo en la terminal)
        sf apex get log --log-id "$log_id" --output-dir .
    else
        echo "‚ö†Ô∏è Tests completed, but could not retrieve a debug log ID."
    fi
}
